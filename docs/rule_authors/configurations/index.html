<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-rule_authors/configurations">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Configurations | Buck2</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://your-docusaurus-test-site.com/docs/rule_authors/configurations/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Configurations | Buck2"><meta data-rh="true" name="description" content="This doc focuses mostly on how configurations and related features are implemented. For"><meta data-rh="true" property="og:description" content="This doc focuses mostly on how configurations and related features are implemented. For"><link data-rh="true" rel="icon" href="/img/logo.png"><link data-rh="true" rel="canonical" href="https://your-docusaurus-test-site.com/docs/rule_authors/configurations/"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/docs/rule_authors/configurations/" hreflang="en"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/docs/rule_authors/configurations/" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.e8ab84c1.css">
<link rel="preload" href="/assets/js/runtime~main.f3d01c19.js" as="script">
<link rel="preload" href="/assets/js/main.c4ec4eda.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Buck2</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/generated/starlark/prelude/">API</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/buck2" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/why/">About Buck2</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/concepts/concept_map/">Concepts</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/commands/">Buck2 Users</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/rule_authors/writing_rules/">Rule Authors</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/writing_rules/">Writing Rules</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/rule_authors/rule_api/">Rule APIs</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/transitive_sets/">Transitive Sets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/rule_authors/configurations/">Configurations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/configuration_transitions/">Configuration Transitions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/dynamic_dependencies/">Dynamic Dependencies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/anon_targets/">Anonymous Targets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/test_execution/">Test Execution</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/optimization/">Optimization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/incremental_actions/">Incremental Actions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/alias/">Alias</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/dep_files/">Dep Files</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/developers/architecture/buck2/">Buck2 Developers</a></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Rule Authors</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Configurations</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Configurations</h1><p>This doc focuses mostly on how configurations and related features are implemented. For
the user docs (which are also quite helpful for understanding this), see ????? (for now
try the <a href="https://buck.build/" target="_blank" rel="noopener noreferrer">buck1 docs</a> or the <a href="https://docs.bazel.build/versions/master/skylark/config.html" target="_blank" rel="noopener noreferrer">bazel docs</a> for similar features that buck2 has been
modeled after).</p><p>TODO(cjhopman): Configurations needs some user docs. Could probably skip some of the below context if we had them.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a class="hash-link" href="#context" title="Direct link to heading">​</a></h2><p>Buck &quot;Configurations&quot; provides an API to express the different ways projects and targets can be built.</p><p>A configuration consists of a set of constraints and config settings (i.e. values from buckconfig). These are determined by a base platform
that sets the initial values and then a series of transitions that may change them.</p><p>The common way that users are exposed to configurations is in <code>select()</code> invocations where the resolution is based on the
configuration.</p><p>A build may involve many configurations and even a particular target label (<code>//:foo</code>) may end up with multiple
instance in the configured graph with different configurations.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="platform-constraint_setting-config_setting-etc"><code>platform()</code>, <code>constraint_setting()</code>, <code>config_setting()</code>, etc<a class="hash-link" href="#platform-constraint_setting-config_setting-etc" title="Direct link to heading">​</a></h3><p>TODO(cjhopman): Describe this enough for context needed below</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="selectable-attributes">Selectable attributes<a class="hash-link" href="#selectable-attributes" title="Direct link to heading">​</a></h2><p>Almost all rule attributes can be set to a <code>select()</code> value, such an attribute is &quot;selectable&quot;. These attributes final resolved value will depend on the configuration.</p><p>There are some attributes that cannot use a <code>select()</code>, such attributes are &quot;not selectable&quot;. Examples include attributes that buck needs to
read from the unconfigured node (ex. &quot;name&quot;, &quot;default_target_platform&quot;) and attributes that are used by <code>platform()</code> rules and their
dependencies (see below).</p><p>TODO(cjhopman): Should rule authors be able to set attrs as not selectable?</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="selectable-resolution">Selectable resolution<a class="hash-link" href="#selectable-resolution" title="Direct link to heading">​</a></h2><p>Resolving selectable attributes is pretty straightforward, it happens when constructing the &quot;configured target node&quot;. At that point, we have the full configuration
available and se we can lookup whether each constraint in the select is satisfied or not.</p><p>TODO(cjhopman): Describe how checking refinement is implemented.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="target-platform-resolution">Target Platform Resolution<a class="hash-link" href="#target-platform-resolution" title="Direct link to heading">​</a></h2><p>When targets are provided on the command line (e.g. <code>buck build //:foo</code>) or otherwise where there&#x27;s no indication of what configuration
that target will be built in, configurations are determined by performing &quot;target platform resolution&quot; on
the unconfigured target labels.</p><p>Target Platform Resolution for a target <code>foo</code> works by:</p><ol><li>lookup (unconfigured) target node for &quot;foo&quot;</li><li>if there&#x27;s a &quot;default_target_platform&quot; attribute, use that</li><li>else, use the cell&#x27;s default platform</li></ol><p>This is performed indepedently for any targets that need a platform. Since this resolution is done without
a configuration, it means that the default_target_platform attribute <strong>is not selectable</strong>.</p><p>This target platform will form the initial configuration for the node.</p><p>TODO(cjhopman): how does a user explicitly specify on the command line a target platform such that the target does not
go through target platform resolution? Are there other cli options/flags/etc that affect target platform resolution?</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-propagation">Configuration propagation<a class="hash-link" href="#configuration-propagation" title="Direct link to heading">​</a></h2><p>Once we&#x27;ve configured the top-level nodes via target platform resolution, the configuration is propagated to dependencies (possibly altered by transitions).</p><p><strong>We do not apply target platform resolution to all nodes in the graph.</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="transitions">Transitions<a class="hash-link" href="#transitions" title="Direct link to heading">​</a></h2><p>A &quot;transition&quot; transforms a configuration by adding or changing constraint values and config settings or by setting an entirely new underlying target platform.</p><p>More details in: <a href="/docs/rule_authors/configuration_transitions/">Configuration transitions</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="configurationinfo-platform-analysis-and-more">ConfigurationInfo, <code>platform()</code> analysis, and more<a class="hash-link" href="#configurationinfo-platform-analysis-and-more" title="Direct link to heading">​</a></h2><p>The definition of a platform (either execution or target) is done with a &quot;platform&quot; rule instance. The configuration is actually
part of the analysis result of the platform target (the ConfigurationInfo provider instance). This is convenient from
an implementation standpoint, but it leads to a situation where some nodes are analyzed with an &quot;unbound&quot; Configuration. All the
rule types involved in defining a platform may be analyzed with an unbound configuration (<code>platform()</code>, <code>config_setting()</code>,
<code>constraint_setting()</code>, etc). These are sometimes called &quot;configuration rules&quot;. This also means that all the attributes of these rules are not selectable.</p><p>Configurations also reference a few other provider instances like ConstraintSettingInfo. All of these end up being potentially
produced in a context with an &quot;unbound&quot; configuration.</p><p>Using analysis for this also means that &quot;configuration&quot; and &quot;analysis&quot; are not distinct phases within a build (though are
still distinct for a node and are still conceptually useful).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="configurations-and-output-paths">Configurations and output paths<a class="hash-link" href="#configurations-and-output-paths" title="Direct link to heading">​</a></h2><p>Because a target may appear within a build in multiple different configurations we cannot derive output paths based on
just targets (as then we&#x27;d have multiple actions map to the same outputs). For this reason, we encode the target and the configuration
into output paths. The configuration is currently represented as a hash of its values (i.e. &quot;hashed buck-out&quot;).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="target-platform-compatibility">Target platform compatibility<a class="hash-link" href="#target-platform-compatibility" title="Direct link to heading">​</a></h2><p>All (non-configuration) rules support a <code>target_compatible_with</code> attribute. In addition, the rule itself can define
<code>target_compatible_with</code> constraints that affect all instances. The <code>target_compatible_with</code> attribute is a list of
constraints/config settings and it <strong>is selectable</strong>.</p><p>Target platform compatibility is transitive, all <em>dependents</em> of an incompatible target are incompatible. In other words,
a node is compatible if and only if the node itself and all of its transitive dependencies are compatible.</p><p>In buck, this is implemented by target analysis returning either the normal analysis result or an indicator
that the node is incompatible with the target platform. It is not part of the &quot;configured target node&quot; because
the &quot;configured target node&quot; does not depend on information from dependencies.</p><p>TODO(cjhopman): Something about debuggability of incompatibility, especially due to needing it to figure out transitive incompatibility.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="buck-v1-compatibility">Buck v1 compatibility<a class="hash-link" href="#buck-v1-compatibility" title="Direct link to heading">​</a></h3><p>Buck2 also supports the Buck v1 legacy <code>compatible_with</code> field on nodes but it has different behavior. In summary:</p><ul><li><code>compatible_with</code>: List of constraints, <em>any</em> of them must match the configuration to be compatible.</li><li><code>target_compatible_with</code>: List of constraints, <em>all</em> of them must match the configuration to be compatible.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="incompatible-target-skipping">Incompatible target skipping<a class="hash-link" href="#incompatible-target-skipping" title="Direct link to heading">​</a></h2><p>In a build-like command where a non-literal target pattern is provided (ex. <code>buck build //:</code> or <code>buck build //foo/...</code>) the target pattern
will be resolved to a set of unconfigured targets. Those targets will then go through &quot;target platform resolution&quot;. If any of those targets
resolve to a platform where they are incompatible, building them will be skipped. Users generally expect and prefer this behavior to
needing to explicit specify only the targets that can build in their current context.</p><p>If an explicitly specified literal is incompatible, it is an error.</p><p>The implementation checks compatibility when looking up the analysis results for configured nodes requested (in the non-ignored flow, it uses
that analysis result to lookup the default outputs and build them).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="execution-platforms">Execution platforms<a class="hash-link" href="#execution-platforms" title="Direct link to heading">​</a></h2><p>Execution platforms/configurations are used to represent the platforms where build execution happens. These are defined similar to target platforms.
These may or may not be what one would logically consider different &quot;platforms&quot;, for example, there could be multiple different execution platforms
that all execute things similarly on the local machine.</p><p>A build configures a fixed list of one or more execution platforms.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="execution-deps">Execution deps<a class="hash-link" href="#execution-deps" title="Direct link to heading">​</a></h2><p>Some target deps are &quot;execution deps&quot;. These are the dependencies of the target that should be built for the execution platform. For example,
a compiler or other build tool would be an execution dep. This includes all exe macro deps (ex. <code>$(exe //:tool)</code>) and includes all <code>attrs.exec_dep()</code> deps.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="toolchain-deps">Toolchain deps<a class="hash-link" href="#toolchain-deps" title="Direct link to heading">​</a></h2><p>In addition to <code>attrs.exec_dep()</code>, we have an <code>attrs.toolchain_dep()</code> primitive that&#x27;s similar but different in an important way. These nodes don&#x27;t select
their execution platform, but instead have it forced on them by whatever includes them, hence it must be recorded in the configured target label.
The execution platform resolution sees through them.</p><p>In other words, <code>attrs.toolchain_dep()</code> is like a mix of <code>attrs.dep()</code> and <code>attrs.exec_dep()</code>: it inherits target platform like <code>attrs.dep()</code> (so any
<code>select()</code>s on the target of the <code>attrs.toolchain_dep()</code> will evaluate as if they were on the target containing the <code>attrs.toolchain_dep()</code> - i.e., target
platform gets inherited as normal) and any <code>attrs.exec_dep()</code>s of the <code>attrs.toolchain_dep()</code> target become <code>attrs.exec_deps()</code> on the dependent of
target the <code>attrs.toolchain_dep()</code> (i.e., they get passed up the dep tree, so participate in exec platfom resolution).</p><p>Illustrated as an example:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">target(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;A&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    toolchain = attrs.toolchain_dep(default = &quot;:B&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">target(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;B&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tool = attrs.exec_dep(default = &quot;:C&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above means that <code>:C</code> will be an execution dependency of <code>:A</code> and any <code>select()</code>s defined in <code>:B</code> would be evaluated against
the same target platform as <code>:A</code> (as target platform gets inherited by <code>attrs.toolchain_dep()</code>s).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="running-non-execution-deps">Running non-execution deps<a class="hash-link" href="#running-non-execution-deps" title="Direct link to heading">​</a></h2><p>If you have a binary that you want to run, but it isn&#x27;t a build tool, then you should use <code>$(exe_target //:binary)</code> rather than <code>$(exe //:binary)</code>. That
will run the same binary that you&#x27;d get from <code>buck2 build</code>, rather than one that is built for the execution platform.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="execution-platform-resolution">Execution platform resolution<a class="hash-link" href="#execution-platform-resolution" title="Direct link to heading">​</a></h2><p>During analysis, unlike target platform resolution, every configured node undergoes execution platform resolution independently (see exception below). This
means that even for a specific target platform, different nodes in the graph can be built on different execution platforms.</p><p>This works roughly like this:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin">next</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> platform </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> execution_platforms</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> exec_compatible_with</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> platform</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> dep </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execution_deps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> !target_compatible_with</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dep</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> platform</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token keyword" style="color:#00009f">continue</span><span class="token plain"> </span><span class="token builtin">next</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> platform</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>One important note here is that until the execution platform has been resolved, <strong>we do not know the configuration for execution deps</strong>. Only after
we&#x27;ve resolved the execution platform can we configure the execution deps (and can also only perform analysis for them at that point).</p><p>For the normal case, a particular configured target node performs execution platform resolution a single time. The execution platform
<strong>is not</strong> encoded in output paths.</p><p>Regarding target compatibility, you can imagine the following pseudo-code for the <code>target_compatible_with()</code> function above:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">target_compatible_with</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cfg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> constraint </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">target_compatible_with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> satisfied</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">constraint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cfg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compatible_with</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        found_satisfied_constraint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> constraint </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compatible_with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> satisfied</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">constraint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cfg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                found_satisfied_constraint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> found_satisfied_constraint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dep</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dep_cfg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> direct_deps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># NB: recursive call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> target_compatible_with</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dep</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dep_cfg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>TODO(cjhopman): What are the requirements on rule authors? Especially, do they need to ensure that all possible execution platforms will produce the same results?</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="execution-groups">Execution groups<a class="hash-link" href="#execution-groups" title="Direct link to heading">​</a></h2><p>Execution groups allow a rule to do execution platform resolution multiple times and then specify which of the resolved platforms each
action runs in.</p><p>TODO(cjhopman): Finish this documentation as we figure it out.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="execution-platform-inheritance">Execution platform inheritance<a class="hash-link" href="#execution-platform-inheritance" title="Direct link to heading">​</a></h2><p>There are some (rare) cases where both a target and its dependency need to resolve to the same execution platform.</p><p>An example of this would be a c++ toolchain that includes both target (ex. the stdlib) and
execution (ex. the compiler) components. In that case, we need the toolchain&#x27;s execution deps to affect its users
execution platform resolution.</p><p>To support this, there are mechanisms to indicate which dependencies need to inherit the execution platform resolution.</p><p>Currently, since this could mean that a configured node appears in the build under multiple different execution platforms and since execution
platforms are not included as part of output paths, users must use this feature carefully.</p><p>TODO(cjhopman): figure out what restrictions this needs to apply so that users don&#x27;t need to be the ones responsible for correctness
TODO(cjhopman): figure out/document those &quot;mechanisms&quot;</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/rule_authors/transitive_sets/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Transitive Sets</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/rule_authors/configuration_transitions/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Configuration Transitions</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#context" class="table-of-contents__link toc-highlight">Context</a><ul><li><a href="#platform-constraint_setting-config_setting-etc" class="table-of-contents__link toc-highlight"><code>platform()</code>, <code>constraint_setting()</code>, <code>config_setting()</code>, etc</a></li></ul></li><li><a href="#selectable-attributes" class="table-of-contents__link toc-highlight">Selectable attributes</a></li><li><a href="#selectable-resolution" class="table-of-contents__link toc-highlight">Selectable resolution</a></li><li><a href="#target-platform-resolution" class="table-of-contents__link toc-highlight">Target Platform Resolution</a></li><li><a href="#configuration-propagation" class="table-of-contents__link toc-highlight">Configuration propagation</a></li><li><a href="#transitions" class="table-of-contents__link toc-highlight">Transitions</a></li><li><a href="#configurationinfo-platform-analysis-and-more" class="table-of-contents__link toc-highlight">ConfigurationInfo, <code>platform()</code> analysis, and more</a></li><li><a href="#configurations-and-output-paths" class="table-of-contents__link toc-highlight">Configurations and output paths</a></li><li><a href="#target-platform-compatibility" class="table-of-contents__link toc-highlight">Target platform compatibility</a><ul><li><a href="#buck-v1-compatibility" class="table-of-contents__link toc-highlight">Buck v1 compatibility</a></li></ul></li><li><a href="#incompatible-target-skipping" class="table-of-contents__link toc-highlight">Incompatible target skipping</a></li><li><a href="#execution-platforms" class="table-of-contents__link toc-highlight">Execution platforms</a></li><li><a href="#execution-deps" class="table-of-contents__link toc-highlight">Execution deps</a></li><li><a href="#toolchain-deps" class="table-of-contents__link toc-highlight">Toolchain deps</a></li><li><a href="#running-non-execution-deps" class="table-of-contents__link toc-highlight">Running non-execution deps</a></li><li><a href="#execution-platform-resolution" class="table-of-contents__link toc-highlight">Execution platform resolution</a></li><li><a href="#execution-groups" class="table-of-contents__link toc-highlight">Execution groups</a></li><li><a href="#execution-platform-inheritance" class="table-of-contents__link toc-highlight">Execution platform inheritance</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/">User guide</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebookincubator/buck2/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub issues<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebookincubator/buck2" target="_blank" rel="noopener noreferrer" class="footer__link-item">Code<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Meta, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.f3d01c19.js"></script>
<script src="/assets/js/main.c4ec4eda.js"></script>
</body>
</html>